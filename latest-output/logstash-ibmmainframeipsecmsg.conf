# Config file generated by RSA2ELK, see https://github.com/blookot/rsa2elk 
# Author: Vincent Maury
# Check all Netwitness parsers: https://github.com/netwitness/nw-logparsers/tree/master/devices/ (license: Apache 2.0)
# Check this link to search for source configuration guides: https://rsa.jiveon.com/community/products/netwitness/integrations/event-sources

##########
# CAUTION: check the "path" in input and "dictionary_path" in filter, as well as the "template" path in the elasticsearch output or "path" in the file output
##########

input {
#	syslog {
#		port => 514
#	}
#	file {
#		path => "/var/log/example.log"
#		start_position => "beginning"
#		sincedb_path => "/dev/null"
#	}
	generator {
		count => 1
		message => "a log line to test out"
	}
#	kafka {
#		codec => "json"
#		bootstrap_servers => "192.168.30.13:9092"
#		topics => ["mytopic"]
#		security_protocol => "SSL"
#		ssl_key_password => "{ssl_password}"
#		ssl_keystore_location => "/{keystore-absolute-path}"
#		ssl_keystore_password => "{keystore_password}"
#		ssl_truststore_location => "/{truststore-absolute-path}"
#		ssl_truststore_password => "{truststore_password}"
#	}
}

# Renaming a couple of fields
filter {
	mutate {
		rename => {
			"message" => "[event][original]"
			"host" => "[logstash][host]"
		}
	}
}

# Setting the device name and group
filter {
	mutate {
		add_field => {
			"[observer][product]" => "ibmmainframeipsec"
			"[observer][name]" => "IBM Mainframe IPSec"
			"[observer][type]" => "Mainframe"
		}
	}
}


# One single filter block for all headers and messages
filter {

################## HEADERS ##################

	# HEADER 0001
	# line in RSA: %IBMMAINFRAMEIPSEC-4: SMF_Type=<hevent_type>|SubType=<messageid>|<!payload:hevent_type>
	if ![logstash][headerfound] {
		grok {
			match => { "[event][original]" => "^%IBMMAINFRAMEIPSEC\-4:[\s]+SMF_Type=(?<message>(?<hevent_type>[^\|]*)\|SubType=(?<messageid>[^\|]*)\|(?<payload>.*))$" }
			id => "header-0001"
			add_field => {
				"[rsa][header][id]" => "0001"
				"[rsa][message][id2]" => "%{messageid}"
				"[logstash][headerfound]" => true
			}
		}
	}
	# HEADER 0002
	# line in RSA: %IBMMAINFRAMEIPSECTVM-4: <!payload>
	if ![logstash][headerfound] {
		dissect {
			mapping => { "[event][original]" => "%IBMMAINFRAMEIPSECTVM-4: %{message}" }
			id => "header-0002"
			add_field => {
				"[rsa][header][id]" => "0002"
				"[rsa][message][id2]" => "IBMMFIPSEC_TVM"
				"[logstash][headerfound]" => true
			}
		}
	}



################## MsgId2 to Parser ##################

	translate {
		field => "[rsa][message][id2]"
		destination => "[logstash][msgparser][id]"
		dictionary_path => "msgid2parserid-ibmmainframeipsecmsg.json"
		fallback => ""
		override => true
	}


################## MESSAGES ##################

	# PARSER msgParserId0
	# line in RSA: <event_type>|SubType=<fld9>|SysId=<hostname>|SubSystem=<instance>|Timestamp=<fld20>|Triplets=<fld11>|Sysname=<fld12>|Sysplex=<fld13>|Stack=<fld14>|RelID=<fld15>|Comp=<fld16>|ASName=<fld17>|UserID=<uid>|ASID=<fld18>|Reason=<fld19>|TCPSocketName=<fld23>|TCPSocketID=<fld24>|Subtask=<fld25>|TIRmtIP=<saddr>|TILocIP=<daddr>|TIRmtPort=<sport>|TILocPort=<dport>|TIConnDateTime=<fld26>|TISTCK=<fld27>| 
	if [logstash][msgparser][id] == "msgParserId0" {
		dissect {
			mapping => { "message" => "%{event_type}|SubType=%{fld9}|SysId=%{hostname}|SubSystem=%{instance}|Timestamp=%{fld20}|Triplets=%{fld11}|Sysname=%{fld12}|Sysplex=%{fld13}|Stack=%{fld14}|RelID=%{fld15}|Comp=%{fld16}|ASName=%{fld17}|UserID=%{uid}|ASID=%{fld18}|Reason=%{fld19}|TCPSocketName=%{fld23}|TCPSocketID=%{fld24}|Subtask=%{fld25}|TIRmtIP=%{saddr}|TILocIP=%{daddr}|TIRmtPort=%{sport}|TILocPort=%{dport}|TIConnDateTime=%{fld26}|TISTCK=%{fld27}|" }
			id => "msgParserId0"
			add_field => {
				"ec_subject" => "NetworkComm"
				"ec_activity" => "Start"
				"ec_theme" => "Configuration"
				"ec_outcome" => "Success"
				"[logstash][fullDateTimeString]" => "%{fld20}"
				"[logstash][messagefound]" => true
			}
		}
		if [logstash][fullDateTimeString] {
			date { match => [ "[logstash][fullDateTimeString]", "d-M-yyyy H:m:s" ] }
		}
	}
	# PARSER msgParserId1
	# line in RSA: <event_type>|SubType=<fld9>|SysId=<hostname>|SubSystem=<instance>|Timestamp=<fld20>|Triplets=<fld11>|Sysname=<fld12>|Sysplex=<fld13>|Stack=<fld14>|RelID=<fld15>|Comp=<fld16>|ASName=<fld17>|UserID=<uid>|ASID=<fld18>|Reason=<fld19>  |TCPSocketName=<fld23>|TCPSocketID=<fld24>|<info>|<fld2>|Term Code=<fld29>|Subtask=<fld25>|TTConnStart=<fld21>|TTConnEnd=<fld22>|TTRmtIP=<saddr>|TTLocIP=<daddr>|TTRmtPort=<sport>|TTLocPort=<dport>|TTBytesIn=<fld30>|TTBytesOut=<fld31>|TTSndWindow@Close=<fld40>|TTMaxSndWindow=<fld41>|TTCongestWindow=<fld42>|TTSndSeg@Close=<fld43>|TTRndTripTime@Close=<fld44>|TTRndTripVar@Close=<fld45>|SocketStat=<fld46>|TTServiceType=<fld48>|TTRetransTimes=<fld49>|TTSvcProf=<fld50>|TTSvcPol=<fld51>|TTInbndSeg=<fld52>|TTOutbndSeg=<fld53>|TTSSTCK=<fld54>|TTESTCK=<fld55>|TTotDupACK=<fld1>|TTTelLUName=<fld32>|TTTelAppl=<fld33>|TTTelLogmode=<fld35>|TTTelStat=<fld34>|Term Code=<fld36>|AT-TLS SSL Proto=<fld37>|AT-TLS Cipher=<fld38>|AT-TLS SecType=<fld26>|AT-TLS Partner UserID=<fld27>|TTApplData=<fld28>|
	else if [logstash][msgparser][id] == "msgParserId1" {
		dissect {
			mapping => { "message" => "%{event_type}|SubType=%{fld9}|SysId=%{hostname}|SubSystem=%{instance}|Timestamp=%{fld20}|Triplets=%{fld11}|Sysname=%{fld12}|Sysplex=%{fld13}|Stack=%{fld14}|RelID=%{fld15}|Comp=%{fld16}|ASName=%{fld17}|UserID=%{uid}|ASID=%{fld18}|Reason=%{fld19}  |TCPSocketName=%{fld23}|TCPSocketID=%{fld24}|%{info}|%{fld2}|Term Code=%{fld29}|Subtask=%{fld25}|TTConnStart=%{fld21}|TTConnEnd=%{fld22}|TTRmtIP=%{saddr}|TTLocIP=%{daddr}|TTRmtPort=%{sport}|TTLocPort=%{dport}|TTBytesIn=%{fld30}|TTBytesOut=%{fld31}|TTSndWindow@Close=%{fld40}|TTMaxSndWindow=%{fld41}|TTCongestWindow=%{fld42}|TTSndSeg@Close=%{fld43}|TTRndTripTime@Close=%{fld44}|TTRndTripVar@Close=%{fld45}|SocketStat=%{fld46}|TTServiceType=%{fld48}|TTRetransTimes=%{fld49}|TTSvcProf=%{fld50}|TTSvcPol=%{fld51}|TTInbndSeg=%{fld52}|TTOutbndSeg=%{fld53}|TTSSTCK=%{fld54}|TTESTCK=%{fld55}|TTotDupACK=%{fld1}|TTTelLUName=%{fld32}|TTTelAppl=%{fld33}|TTTelLogmode=%{fld35}|TTTelStat=%{fld34}|Term Code=%{fld36}|AT-TLS SSL Proto=%{fld37}|AT-TLS Cipher=%{fld38}|AT-TLS SecType=%{fld26}|AT-TLS Partner UserID=%{fld27}|TTApplData=%{fld28}|" }
			id => "msgParserId1"
			add_field => {
				"ec_subject" => "NetworkComm"
				"ec_activity" => "Stop"
				"ec_theme" => "Configuration"
				"ec_outcome" => "Success"
				"[logstash][fullDateTimeString]" => "%{fld20}"
				"[logstash][messagefound]" => true
			}
		}
		if [logstash][fullDateTimeString] {
			date { match => [ "[logstash][fullDateTimeString]", "d-M-yyyy H:m:s" ] }
		}
	}
	# PARSER msgParserId2
	# line in RSA: <event_type>|SubType=<fld9>|SysId=<hostname>|SubSystem=<instance>|Timestamp=<fld20>|Triplets=<fld11>|Sysname=<fld12>|Sysplex=<fld13>|Stack=<fld14>|RelID=<fld15>|Comp=<fld16>|ASName=<fld17>|UserID=<uid>|ASID=<fld18>|Reason=<fld19>|FTPCmnd=<fld29>|FTPType=<fld25>|FCDRmtIP=<saddr>|FCDLocIP=<daddr>|FCDRmtPort=<sport>|FCDLocPort=<dport>|FCCRmtIP=<fld27>|FCCLocIP=<fld35>|FCDRmtPort=<fld36>|FCDLocPort=<fld38>|FTPRmtUser=<fld37>FTPLocUser=<fld39>|FTPType=<fld30>|FTPMode=<fld31>|FTPStruc=<fld40>|FTPDStype=<fld41>|FTStrtDateTime=<fld21>|FTEndDateTime=<fld22>|FTDur=<fld42>|FTBytes=<fld43>|FTReply=<fld44>|FTPDSMem=<fld45>|FTHost=<fld46>|FTAbend=<fld48>|FTBytesFlt=<fld49>|FTCtrlConn=<fld50>|FTDataConn=<fld51>|FTFileName=<fld52>|SOCKSIP=<fld53>|SOCKSPort=<fld54>|SOCKSProto=<fld55>|FTProtMech=<fld56>|FTCntrlProtLevel=<fld57>|FTDataProtLevel=<fld58>|FTLoginMethod=<fld59>|FTProtocolLvl=<fld60>|FTCipherSpec=<fld1>|FTProtBuffSize=<fld2>|FTCipher=<fld3>|FTFileUserID=<fld4>|
	else if [logstash][msgparser][id] == "msgParserId2" {
		dissect {
			mapping => { "message" => "%{event_type}|SubType=%{fld9}|SysId=%{hostname}|SubSystem=%{instance}|Timestamp=%{fld20}|Triplets=%{fld11}|Sysname=%{fld12}|Sysplex=%{fld13}|Stack=%{fld14}|RelID=%{fld15}|Comp=%{fld16}|ASName=%{fld17}|UserID=%{uid}|ASID=%{fld18}|Reason=%{fld19}|FTPCmnd=%{fld29}|FTPType=%{fld25}|FCDRmtIP=%{saddr}|FCDLocIP=%{daddr}|FCDRmtPort=%{sport}|FCDLocPort=%{dport}|FCCRmtIP=%{fld27}|FCCLocIP=%{fld35}|FCDRmtPort=%{fld36}|FCDLocPort=%{fld38}|FTPRmtUser=%{fld37}FTPLocUser=%{fld39}|FTPType=%{fld30}|FTPMode=%{fld31}|FTPStruc=%{fld40}|FTPDStype=%{fld41}|FTStrtDateTime=%{fld21}|FTEndDateTime=%{fld22}|FTDur=%{fld42}|FTBytes=%{fld43}|FTReply=%{fld44}|FTPDSMem=%{fld45}|FTHost=%{fld46}|FTAbend=%{fld48}|FTBytesFlt=%{fld49}|FTCtrlConn=%{fld50}|FTDataConn=%{fld51}|FTFileName=%{fld52}|SOCKSIP=%{fld53}|SOCKSPort=%{fld54}|SOCKSProto=%{fld55}|FTProtMech=%{fld56}|FTCntrlProtLevel=%{fld57}|FTDataProtLevel=%{fld58}|FTLoginMethod=%{fld59}|FTProtocolLvl=%{fld60}|FTCipherSpec=%{fld1}|FTProtBuffSize=%{fld2}|FTCipher=%{fld3}|FTFileUserID=%{fld4}|" }
			id => "msgParserId2"
			add_field => {
				"ec_subject" => "NetworkComm"
				"ec_activity" => "Receive"
				"ec_theme" => "Configuration"
				"ec_outcome" => "Success"
				"[logstash][fullDateTimeString]" => "%{fld20}"
				"[logstash][messagefound]" => true
			}
		}
		if [logstash][fullDateTimeString] {
			date { match => [ "[logstash][fullDateTimeString]", "d-M-yyyy H:m:s" ] }
		}
	}
	# PARSER msgParserId3
	# line in RSA: <event_type>|SubType=<fld9>|SysId=<hostname>|SubSystem=<instance>|Timestamp=<fld20>|Triplets=<fld11>|Sysname=<fld12>|Sysplex=<fld13>|Stack=<fld14>|RelID=<fld15>|Comp=<fld16>|ASName=<fld17>|UserID=<uid>|ASID=<fld18>|Reason=<fld19>|TNLUName=<fld32>|TNHost=<fld33>|TNDev=<fld34>|TNRmtIP=<saddr>|TNLocIP=<daddr>|TNRmtPort=<sport>|TNLocPort=<dport>|TNInitDateTime=<fld21>|
	else if [logstash][msgparser][id] == "msgParserId3" {
		dissect {
			mapping => { "message" => "%{event_type}|SubType=%{fld9}|SysId=%{hostname}|SubSystem=%{instance}|Timestamp=%{fld20}|Triplets=%{fld11}|Sysname=%{fld12}|Sysplex=%{fld13}|Stack=%{fld14}|RelID=%{fld15}|Comp=%{fld16}|ASName=%{fld17}|UserID=%{uid}|ASID=%{fld18}|Reason=%{fld19}|TNLUName=%{fld32}|TNHost=%{fld33}|TNDev=%{fld34}|TNRmtIP=%{saddr}|TNLocIP=%{daddr}|TNRmtPort=%{sport}|TNLocPort=%{dport}|TNInitDateTime=%{fld21}|" }
			id => "msgParserId3"
			add_field => {
				"ec_subject" => "NetworkComm"
				"ec_activity" => "Start"
				"ec_theme" => "Configuration"
				"ec_outcome" => "Success"
				"[logstash][fullDateTimeString]" => "%{fld20}"
				"[logstash][messagefound]" => true
			}
		}
		if [logstash][fullDateTimeString] {
			date { match => [ "[logstash][fullDateTimeString]", "d-M-yyyy H:m:s" ] }
		}
	}
	# PARSER msgParserId4
	# line in RSA: <event_type>|SubType=<fld9>|SysId=<hostname>|SubSystem=<instance>|Timestamp=<fld20>|Triplets=<fld11>|Sysname=<fld12>|Sysplex=<fld13>|Stack=<fld14>|RelID=<fld15>|Comp=<fld16>|ASName=<fld17>|UserID=<uid>|ASID=<fld18>|Reason=<fld19>|TNLUName=<fld32>|TNHost=<fld33>|TNDev=<fld34>|TNRmtIP=<saddr>|TNLocIP=<daddr>|TNRmtPort=<sport>|TNLocPort=<dport>|TNHost=<fld29>|TNBytesIn=<fld30>|TNBytesOut=<fld31>|TNInitDateTime=<fld21>|TNTermDateTime=<fld22>|TNDur=<fld41>|TNSessType=<fld47>|TNLUSelType=<fld49>|TNSSLStatus=<fld28>|TNConnOpt=<fld42>|TN3270ConnOpt=<fld43>|TNRetCode=<fld44>|TNLogMode=<fld45>|TNDevType=<fld46>|TNHostName=<fld48>|TNRndTripMillisec=<fld50>|TNIPRndTripMillisec=<fld51>|TNCntTrans=<fld52>|TNCntIPTrans=<fld53>|TNElapsRTrpSq=<fld54>|TNElapsIpRTrpSq=<fld55>|TNElapsSnaRTrpSq=<fld56>|TNGrpIndx=<fld57>|TNIpTrpMeasure=<fld58>|TNRndUprBndBkt1Millisec=<fld23>|TNRndUprBndBkt2Millisec=<fld24>|TNRndUprBndBkt3Millisec=<fld25>|TNRndUprBndBkt4Millisec=<fld26>|TNNbrTransBkt1Criteria=<fld27>|TNNbrTransBkt2Criteria=<fld59>|TNNbrTransBkt3Criteria=<fld60>|TNNbrTransBkt4Criteria=<fld1>|TNNbrTransExceedBkt4=<fld2>|
	else if [logstash][msgparser][id] == "msgParserId4" {
		dissect {
			mapping => { "message" => "%{event_type}|SubType=%{fld9}|SysId=%{hostname}|SubSystem=%{instance}|Timestamp=%{fld20}|Triplets=%{fld11}|Sysname=%{fld12}|Sysplex=%{fld13}|Stack=%{fld14}|RelID=%{fld15}|Comp=%{fld16}|ASName=%{fld17}|UserID=%{uid}|ASID=%{fld18}|Reason=%{fld19}|TNLUName=%{fld32}|TNHost=%{fld33}|TNDev=%{fld34}|TNRmtIP=%{saddr}|TNLocIP=%{daddr}|TNRmtPort=%{sport}|TNLocPort=%{dport}|TNHost=%{fld29}|TNBytesIn=%{fld30}|TNBytesOut=%{fld31}|TNInitDateTime=%{fld21}|TNTermDateTime=%{fld22}|TNDur=%{fld41}|TNSessType=%{fld47}|TNLUSelType=%{fld49}|TNSSLStatus=%{fld28}|TNConnOpt=%{fld42}|TN3270ConnOpt=%{fld43}|TNRetCode=%{fld44}|TNLogMode=%{fld45}|TNDevType=%{fld46}|TNHostName=%{fld48}|TNRndTripMillisec=%{fld50}|TNIPRndTripMillisec=%{fld51}|TNCntTrans=%{fld52}|TNCntIPTrans=%{fld53}|TNElapsRTrpSq=%{fld54}|TNElapsIpRTrpSq=%{fld55}|TNElapsSnaRTrpSq=%{fld56}|TNGrpIndx=%{fld57}|TNIpTrpMeasure=%{fld58}|TNRndUprBndBkt1Millisec=%{fld23}|TNRndUprBndBkt2Millisec=%{fld24}|TNRndUprBndBkt3Millisec=%{fld25}|TNRndUprBndBkt4Millisec=%{fld26}|TNNbrTransBkt1Criteria=%{fld27}|TNNbrTransBkt2Criteria=%{fld59}|TNNbrTransBkt3Criteria=%{fld60}|TNNbrTransBkt4Criteria=%{fld1}|TNNbrTransExceedBkt4=%{fld2}|" }
			id => "msgParserId4"
			add_field => {
				"ec_subject" => "NetworkComm"
				"ec_activity" => "Stop"
				"ec_theme" => "Configuration"
				"ec_outcome" => "Success"
				"[logstash][fullDateTimeString]" => "%{fld20}"
				"[logstash][messagefound]" => true
			}
		}
		if [logstash][fullDateTimeString] {
			date { match => [ "[logstash][fullDateTimeString]", "d-M-yyyy H:m:s" ] }
		}
	}
	# PARSER msgParserId5
	# line in RSA: <event_type>|SubType=<fld9>|SysId=<hostname>|SubSystem=<instance>|Timestamp=<fld20>|Triplets=<fld11>|Sysname=<fld12>|Sysplex=<fld13>|Stack=<fld14>|RelID=<fld15>|Comp=<fld16>|ASName=<fld17>|UserID=<uid>|ASID=<fld18>|Reason=<fld19>|TNCIRmtIP=<saddr>|TNCILocIP=<daddr>|TNCIRmtPort=<sport>|TNCILocPort=<dport>|TNCIInitDateTime=<fld21>|
	else if [logstash][msgparser][id] == "msgParserId5" {
		dissect {
			mapping => { "message" => "%{event_type}|SubType=%{fld9}|SysId=%{hostname}|SubSystem=%{instance}|Timestamp=%{fld20}|Triplets=%{fld11}|Sysname=%{fld12}|Sysplex=%{fld13}|Stack=%{fld14}|RelID=%{fld15}|Comp=%{fld16}|ASName=%{fld17}|UserID=%{uid}|ASID=%{fld18}|Reason=%{fld19}|TNCIRmtIP=%{saddr}|TNCILocIP=%{daddr}|TNCIRmtPort=%{sport}|TNCILocPort=%{dport}|TNCIInitDateTime=%{fld21}|" }
			id => "msgParserId5"
			add_field => {
				"ec_subject" => "NetworkComm"
				"ec_activity" => "Start"
				"ec_theme" => "Configuration"
				"ec_outcome" => "Success"
				"[logstash][fullDateTimeString]" => "%{fld20}"
				"[logstash][messagefound]" => true
			}
		}
		if [logstash][fullDateTimeString] {
			date { match => [ "[logstash][fullDateTimeString]", "d-M-yyyy H:m:s" ] }
		}
	}
	# PARSER msgParserId6
	# line in RSA: <event_type>|SubType=<fld9>|SysId=<hostname>|SubSystem=<instance>|Timestamp=<fld20>|Triplets=<fld11>|Sysname=<fld12>|Sysplex=<fld13>|Stack=<fld14>|RelID=<fld15>|Comp=<fld16>|ASName=<fld17>|UserID=<uid>|ASID=<fld18>|Reason=<fld19>|TNCTRmtIP=<saddr>|TNCTLocIP=<daddr>|TNCTRmtPort=<sport>|TNCTLocPort=<dport>|TNCTNJENode=<fld27>|TNCTTBytesIn=<fld30>|TNCTTBytesOut=<fld31>|TNCTInitDateTime= <fld21>|TNCTInitDateTime= <fld22>|TNCTDur=<fld40>|TNCTConnOpt=<fld36>|TNCTDevType=<fld38>|
	else if [logstash][msgparser][id] == "msgParserId6" {
		dissect {
			mapping => { "message" => "%{event_type}|SubType=%{fld9}|SysId=%{hostname}|SubSystem=%{instance}|Timestamp=%{fld20}|Triplets=%{fld11}|Sysname=%{fld12}|Sysplex=%{fld13}|Stack=%{fld14}|RelID=%{fld15}|Comp=%{fld16}|ASName=%{fld17}|UserID=%{uid}|ASID=%{fld18}|Reason=%{fld19}|TNCTRmtIP=%{saddr}|TNCTLocIP=%{daddr}|TNCTRmtPort=%{sport}|TNCTLocPort=%{dport}|TNCTNJENode=%{fld27}|TNCTTBytesIn=%{fld30}|TNCTTBytesOut=%{fld31}|TNCTInitDateTime= %{fld21}|TNCTInitDateTime= %{fld22}|TNCTDur=%{fld40}|TNCTConnOpt=%{fld36}|TNCTDevType=%{fld38}|" }
			id => "msgParserId6"
			add_field => {
				"ec_subject" => "NetworkComm"
				"ec_activity" => "Stop"
				"ec_theme" => "Configuration"
				"ec_outcome" => "Success"
				"[logstash][fullDateTimeString]" => "%{fld20}"
				"[logstash][messagefound]" => true
			}
		}
		if [logstash][fullDateTimeString] {
			date { match => [ "[logstash][fullDateTimeString]", "d-M-yyyy H:m:s" ] }
		}
	}
	# PARSER msgParserId7
	# line in RSA: <event_type>|SubType=<fld9>|SysId=<hostname>|SubSystem=<instance>|Timestamp=<fld20>|Triplets=<fld11>|Sysname=<fld12>|Sysplex=<fld13>|Stack=<fld14>|RelID=<fld15>|Comp=<fld16>|ASName=<fld17>|UserID=<uid>|ASID=<fld18>|Reason=<fld19>|FSOper=<fld174>|FSCmnd=<fld34>|FSType=<fld37>FSDRmtIP=<saddr>|FSDLocIP=<daddr>|FSDRmtPort=<sport>|FSDLocPort=<dport>|FSCRmtIP=<fld27>|FSCLocIP=<fld35>|FSDRmtPort=<fld36>|FSDLocPort=<fld38>|FSClntUser=<fld30>|FSType=<fld31>|FSMode=<fld40>|FSStruc=<fld41>|FSDStype=<fld42>|FSStrtDateTime=<fld21>|FSEndDateTime=<fld22>|FSDur=<fld43>|FSBytes=<fld44>|FSReply=<fld45>|FSPDSMem=<fld46>|FSAbend=<fld48>|FSPDS2Mem=<fld49>|FSBytesFlt=<fld50>|FSCtrlConn=<fld51>|FSDataConn=<fld52>|FSSessID=<fld53>|FSHostName=<fld54>|FSFileName1=<fld55>|FSFileName2=<fld56>|FSProtMech=<fld57>|FSCntrlProtLevel=<fld23>|FSDataProtLevel=<fld24>|FSLoginMethod=<fld25>|FSProtocolLvl=<fld26>|FSCipherSpec=<fld58>|FSProtBuffSize=<fld28>|FSCipher=<fld29>|
	else if [logstash][msgparser][id] == "msgParserId7" {
		dissect {
			mapping => { "message" => "%{event_type}|SubType=%{fld9}|SysId=%{hostname}|SubSystem=%{instance}|Timestamp=%{fld20}|Triplets=%{fld11}|Sysname=%{fld12}|Sysplex=%{fld13}|Stack=%{fld14}|RelID=%{fld15}|Comp=%{fld16}|ASName=%{fld17}|UserID=%{uid}|ASID=%{fld18}|Reason=%{fld19}|FSOper=%{fld174}|FSCmnd=%{fld34}|FSType=%{fld37}FSDRmtIP=%{saddr}|FSDLocIP=%{daddr}|FSDRmtPort=%{sport}|FSDLocPort=%{dport}|FSCRmtIP=%{fld27}|FSCLocIP=%{fld35}|FSDRmtPort=%{fld36}|FSDLocPort=%{fld38}|FSClntUser=%{fld30}|FSType=%{fld31}|FSMode=%{fld40}|FSStruc=%{fld41}|FSDStype=%{fld42}|FSStrtDateTime=%{fld21}|FSEndDateTime=%{fld22}|FSDur=%{fld43}|FSBytes=%{fld44}|FSReply=%{fld45}|FSPDSMem=%{fld46}|FSAbend=%{fld48}|FSPDS2Mem=%{fld49}|FSBytesFlt=%{fld50}|FSCtrlConn=%{fld51}|FSDataConn=%{fld52}|FSSessID=%{fld53}|FSHostName=%{fld54}|FSFileName1=%{fld55}|FSFileName2=%{fld56}|FSProtMech=%{fld57}|FSCntrlProtLevel=%{fld23}|FSDataProtLevel=%{fld24}|FSLoginMethod=%{fld25}|FSProtocolLvl=%{fld26}|FSCipherSpec=%{fld58}|FSProtBuffSize=%{fld28}|FSCipher=%{fld29}|" }
			id => "msgParserId7"
			add_field => {
				"ec_subject" => "NetworkComm"
				"ec_activity" => "Receive"
				"ec_theme" => "Configuration"
				"ec_outcome" => "Success"
				"[logstash][fullDateTimeString]" => "%{fld20}"
				"[logstash][messagefound]" => true
			}
		}
		if [logstash][fullDateTimeString] {
			date { match => [ "[logstash][fullDateTimeString]", "d-M-yyyy H:m:s" ] }
		}
	}
	# PARSER msgParserId8
	# line in RSA: <event_type>|SubType=<fld9>|SysId=<hostname>|SubSystem=<instance>|Timestamp=<fld20>|Triplets=<fld11>|Sysname=<fld12>|Sysplex=<fld13>|Stack=<fld14>|RelID=<fld15>|Comp=<fld16>|ASName=<fld17>|UserID=<uid>|ASID=<fld18>|Reason=<fld19>|FFRmtIP=<saddr>|FFLocIP=<daddr>|FFRmtPort=<sport>|FFLocPort=<dport>|FFClntUser=<fld27>|FFRsn=<fld35>|FFCtrlConnID=<fld36>|FFSessID=<fld38>|FFProtMech=<fld37>|FFCntrlProtLevel=<fld39>|FFDataProtLevel=<fld30>|FFLoginMethod=<fld31>|FFProtocolLvl=<fld40>|FFCipherSpec=<fld41>|FFProtBuffSize=<fld42>|FFCipher=<fld43>|
	else if [logstash][msgparser][id] == "msgParserId8" {
		dissect {
			mapping => { "message" => "%{event_type}|SubType=%{fld9}|SysId=%{hostname}|SubSystem=%{instance}|Timestamp=%{fld20}|Triplets=%{fld11}|Sysname=%{fld12}|Sysplex=%{fld13}|Stack=%{fld14}|RelID=%{fld15}|Comp=%{fld16}|ASName=%{fld17}|UserID=%{uid}|ASID=%{fld18}|Reason=%{fld19}|FFRmtIP=%{saddr}|FFLocIP=%{daddr}|FFRmtPort=%{sport}|FFLocPort=%{dport}|FFClntUser=%{fld27}|FFRsn=%{fld35}|FFCtrlConnID=%{fld36}|FFSessID=%{fld38}|FFProtMech=%{fld37}|FFCntrlProtLevel=%{fld39}|FFDataProtLevel=%{fld30}|FFLoginMethod=%{fld31}|FFProtocolLvl=%{fld40}|FFCipherSpec=%{fld41}|FFProtBuffSize=%{fld42}|FFCipher=%{fld43}|" }
			id => "msgParserId8"
			add_field => {
				"ec_subject" => "NetworkComm"
				"ec_activity" => "Logon"
				"ec_theme" => "Authentication"
				"ec_outcome" => "Failure"
				"[logstash][fullDateTimeString]" => "%{fld20}"
				"[logstash][messagefound]" => true
			}
		}
		if [logstash][fullDateTimeString] {
			date { match => [ "[logstash][fullDateTimeString]", "d-M-yyyy H:m:s" ] }
		}
	}
	# PARSER msgParserId9
	# line in RSA: SMFType=<event_type>|SubType=<fld2>|SysId=<hostname>|SubSystem=<instance>|Timestamp=<fld5>|Triplets=<fld6>|Sysname=<fld7>|Sysplex=<fld8>|Stack=<fld9>|RelID=<fld10>|Comp=<fld11>|ASName=<fld12>|UserID=<uid>|ASID=<fld14>|Reason=<fld15>|TCPSocketName=<fld16>|TCPSocketID=<fld17>|Subtask=<fld18>|TIRmtIP=<saddr>|TILocIP=<daddr>|TIRmtPort=<sport>|TILocPort=<dport>|TIConnDateTime=<fld23>|TISTCK=<fld24>|AT_TLS_Conn=<fld25>|AT_TLS_Policy=<fld26>|TermCode=<fld27>|TTConnStart=<fld28>|TTConnEnd=<fld29>|TTRmtIP=<saddr>|TTLocIP=<daddr>|TTRmtPort=<sport>|TTLocPort=<dport>|TTBytesIn=<fld34>|TTBytesOut=<fld35>|TTSndWindow@Close=<fld36>|TTMaxSndWindow=<fld37>|TTCongestWindow=<fld38>|TTSndSeg@Close=<fld39>|TTRndTripTime@Close=<fld40>|TTRndTripVar@Close=<fld41>|SocketStat=<fld42>|TTServiceType=<fld43>|TTRetransTimes=<fld44>|TTSvcProf=<fld45>|TTSvcPol=<fld46>|TTInbndSeg=<fld47>|TTOutbndSeg=<fld48>|TTSSTCK=<fld49>|TTESTCK=<fld50>|TTotDupACK=<fld51>|TTTelLUName=<fld52>|TTTelAppl=<fld53>|TTTelLogmode=<fld54>|TTTelStat=<fld55>|TelTermCode=<fld56>|AT_TLS_SSL_Proto=<fld57>|AT_TLS_Cipher=<fld58>|AT_TLS_SecType=<fld59>|AT_TLS_Partner_UserID=<fld60>|TTApplData=<fld76>|FTPCmnd=<fld77>|FCDRmtIP=<saddr>|FCDLocIP=<daddr>|FCDRmtPort=<sport>|FCDLocPort=<dport>|FCCRmtIP=<fld82>|FCCLocIP=<fld83>|FCCRmtPort=<fld84>|FCCLocPort=<fld85>|FTPRmtUser=<fld86>|FTPLocUser=<fld87>|FCType=<fld88>|FTPMode=<fld89>|FTPStruc=<fld90>|FTPDStype=<fld91>|FTStrtDateTime=<fld92>|FTEndDateTime=<fld93>|FTDur=<fld94>|FTBytes=<fld95>|FTReply=<fld96>|FTPDSMem=<fld97>|FTHost=<fld98>|FTAbend=<fld99>|FTBytesFlt=<fld100>|FTCtrlConn=<fld101>|FTDataConn=<fld102>|FTFileName=<fld103>|SOCKSIP=<fld104>|SOCKSPort=<fld105>|SOCKSProto=<fld106>|FTProtMech=<fld107>|FTCntrlProtLevel=<fld108>|FTDataProtLevel=<fld109>|FTLoginMethod=<fld110>|FTProtocolLvl=<fld111>|FTCipherSpec=<fld112>|FTProtBuffSize=<fld113>|FTCipher=<fld114>|FTFileUserID=<fld115>|TNLUName=<fld116>|TNAppl=<fld117>|TNDev=<fld118>|TNRmtIP=<saddr>|TNLocIP=<daddr>|TNRmtPort=<sport>|TNLocPort=<dport>|TNInitDateTime=<fld123>|TNHost=<fld124>|TNBytesIn=<fld125>|TNBytesOut=<fld126>|TNTermDateTime=<fld127>|TNDur=<fld128>|TNSessType=<fld129>|TNLUSelType=<fld130>|TNSSLStatus=<fld131>|TNConnOpt=<fld132>|TN3270ConnOpt=<fld133>|TNRetCode=<fld134>|TNLogMode=<fld135>|TNDevType=<fld136>|TNHostName=<fld137>|TNRndTripMillisec=<fld138>|TNIPRndTripMillisec=<fld139>|TNCntTrans=<fld140>|TNCntIPTrans=<fld141>|TNElapsRTrpSq=<fld142>|TNElapsIpRTrpSq=<fld143>|TNElapsSnaRTrpSq=<fld144>|TNGrpIndx=<fld145>|TNIpTrpMeasure=<fld146>|TNRndUprBndBkt1Millisec=<fld147>|TNRndUprBndBkt2Millisec=<fld148>|TNRndUprBndBkt3Millisec=<fld149>|TNRndUprBndBkt4Millisec=<fld150>|TNNbrTransBkt1Criteria=<fld151>|TNNbrTransBkt2Criteria=<fld152>|TNNbrTransBkt3Criteria=<fld153>|TNNbrTransBkt4Criteria=<fld154>|TNNbrTransExceedBkt4=<fld155>|TNCIRmtIP=<saddr>|TNCILocIP=<daddr>|TNCIRmtPort=<sport>|TNCILocPort=<dport>|TNCIInitDateTime=<fld160>|TNCTRmtIP=<saddr>|TNCTLocIP=<daddr>|TNCTRmtPort=<sport>|TNCTLocPort=<dport>|TNCTNJENode=<fld165>|TNCTTBytesIn=<fld166>|TNCTTBytesOut=<fld167>|TNCTInitDateTime=<fld168>|TNCTTnitDateTime=<fld169>|TNCTDur=<fld170>|TNCTConnOpt=<fld171>|TNCTDevType=<fld172>|FSOper=<fld173>|FSCmnd=<fld174>|FSDRmtIP=<saddr>|FSDLocIP=<daddr>|FSDRmtPort=<sport>|FSDLocPort=<dport>|FSCRmtIP=<fld179>|FSCLocIP=<fld180>|FSCRmtPort=<fld181>|FSCLocPort=<fld182>|FSClntUser=<fld183>|FSDType=<fld184>|FSMode=<fld185>|FSStruc=<fld186>|FSDStype=<fld187>|FSStrtDateTime=<fld188>|FSEndDateTime=<fld189>|FSDur=<fld190>|FSBytes=<fld191>|FSReply=<fld192>|FSPDSMem=<fld193>|FSAbend=<fld194>|FSPDS2Mem=<fld195>|FSBytesFlt=<fld196>|FSCtrlConn=<fld197>|FSDataConn=<fld198>|FSSessID=<fld199>|FSHostName=<fld200>|FSFileName1=<fld201>|FSFileName2=<fld202>|FSProtMech=<fld203>|FSCntrlProtLevel=<fld204>|FSDataProtLevel=<fld205>|FSLoginMethod=<fld206>|FSProtocolLvl=<fld207>|FSCipherSpec=<fld208>|FSProtBuffSize=<fld209>|FSCipher=<fld210>|FFRmtIP=<saddr>|FFLocIP=<daddr>|FFRmtPort=<sport>|FFLocPort=<dport>|FFClntUser=<fld215>|FFRsn=<fld216>|FFCtrlConnID=<fld217>|FFSessID=<fld218>|FFProtMech=<fld219>|FFCntrlProtLevel=<fld220>|FFDataProtLevel=<fld221>|FFLoginMethod=<fld222>|FFProtocolLvl=<fld223>|FFCipherSpec=<fld224>|FFProtBuffSize=<fld225>|FFCipher=<fld226>|FCFType=<fld227>|FSFType=<fld228>|FTPType=<fld1>|FSType=<fld3>
	else if [logstash][msgparser][id] == "msgParserId9" {
		dissect {
			mapping => { "message" => "SMFType=%{event_type}|SubType=%{fld2}|SysId=%{hostname}|SubSystem=%{instance}|Timestamp=%{fld5}|Triplets=%{fld6}|Sysname=%{fld7}|Sysplex=%{fld8}|Stack=%{fld9}|RelID=%{fld10}|Comp=%{fld11}|ASName=%{fld12}|UserID=%{uid}|ASID=%{fld14}|Reason=%{fld15}|TCPSocketName=%{fld16}|TCPSocketID=%{fld17}|Subtask=%{fld18}|TIRmtIP=%{saddr}|TILocIP=%{daddr}|TIRmtPort=%{sport}|TILocPort=%{dport}|TIConnDateTime=%{fld23}|TISTCK=%{fld24}|AT_TLS_Conn=%{fld25}|AT_TLS_Policy=%{fld26}|TermCode=%{fld27}|TTConnStart=%{fld28}|TTConnEnd=%{fld29}|TTRmtIP=%{saddr}|TTLocIP=%{daddr}|TTRmtPort=%{sport}|TTLocPort=%{dport}|TTBytesIn=%{fld34}|TTBytesOut=%{fld35}|TTSndWindow@Close=%{fld36}|TTMaxSndWindow=%{fld37}|TTCongestWindow=%{fld38}|TTSndSeg@Close=%{fld39}|TTRndTripTime@Close=%{fld40}|TTRndTripVar@Close=%{fld41}|SocketStat=%{fld42}|TTServiceType=%{fld43}|TTRetransTimes=%{fld44}|TTSvcProf=%{fld45}|TTSvcPol=%{fld46}|TTInbndSeg=%{fld47}|TTOutbndSeg=%{fld48}|TTSSTCK=%{fld49}|TTESTCK=%{fld50}|TTotDupACK=%{fld51}|TTTelLUName=%{fld52}|TTTelAppl=%{fld53}|TTTelLogmode=%{fld54}|TTTelStat=%{fld55}|TelTermCode=%{fld56}|AT_TLS_SSL_Proto=%{fld57}|AT_TLS_Cipher=%{fld58}|AT_TLS_SecType=%{fld59}|AT_TLS_Partner_UserID=%{fld60}|TTApplData=%{fld76}|FTPCmnd=%{fld77}|FCDRmtIP=%{saddr}|FCDLocIP=%{daddr}|FCDRmtPort=%{sport}|FCDLocPort=%{dport}|FCCRmtIP=%{fld82}|FCCLocIP=%{fld83}|FCCRmtPort=%{fld84}|FCCLocPort=%{fld85}|FTPRmtUser=%{fld86}|FTPLocUser=%{fld87}|FCType=%{fld88}|FTPMode=%{fld89}|FTPStruc=%{fld90}|FTPDStype=%{fld91}|FTStrtDateTime=%{fld92}|FTEndDateTime=%{fld93}|FTDur=%{fld94}|FTBytes=%{fld95}|FTReply=%{fld96}|FTPDSMem=%{fld97}|FTHost=%{fld98}|FTAbend=%{fld99}|FTBytesFlt=%{fld100}|FTCtrlConn=%{fld101}|FTDataConn=%{fld102}|FTFileName=%{fld103}|SOCKSIP=%{fld104}|SOCKSPort=%{fld105}|SOCKSProto=%{fld106}|FTProtMech=%{fld107}|FTCntrlProtLevel=%{fld108}|FTDataProtLevel=%{fld109}|FTLoginMethod=%{fld110}|FTProtocolLvl=%{fld111}|FTCipherSpec=%{fld112}|FTProtBuffSize=%{fld113}|FTCipher=%{fld114}|FTFileUserID=%{fld115}|TNLUName=%{fld116}|TNAppl=%{fld117}|TNDev=%{fld118}|TNRmtIP=%{saddr}|TNLocIP=%{daddr}|TNRmtPort=%{sport}|TNLocPort=%{dport}|TNInitDateTime=%{fld123}|TNHost=%{fld124}|TNBytesIn=%{fld125}|TNBytesOut=%{fld126}|TNTermDateTime=%{fld127}|TNDur=%{fld128}|TNSessType=%{fld129}|TNLUSelType=%{fld130}|TNSSLStatus=%{fld131}|TNConnOpt=%{fld132}|TN3270ConnOpt=%{fld133}|TNRetCode=%{fld134}|TNLogMode=%{fld135}|TNDevType=%{fld136}|TNHostName=%{fld137}|TNRndTripMillisec=%{fld138}|TNIPRndTripMillisec=%{fld139}|TNCntTrans=%{fld140}|TNCntIPTrans=%{fld141}|TNElapsRTrpSq=%{fld142}|TNElapsIpRTrpSq=%{fld143}|TNElapsSnaRTrpSq=%{fld144}|TNGrpIndx=%{fld145}|TNIpTrpMeasure=%{fld146}|TNRndUprBndBkt1Millisec=%{fld147}|TNRndUprBndBkt2Millisec=%{fld148}|TNRndUprBndBkt3Millisec=%{fld149}|TNRndUprBndBkt4Millisec=%{fld150}|TNNbrTransBkt1Criteria=%{fld151}|TNNbrTransBkt2Criteria=%{fld152}|TNNbrTransBkt3Criteria=%{fld153}|TNNbrTransBkt4Criteria=%{fld154}|TNNbrTransExceedBkt4=%{fld155}|TNCIRmtIP=%{saddr}|TNCILocIP=%{daddr}|TNCIRmtPort=%{sport}|TNCILocPort=%{dport}|TNCIInitDateTime=%{fld160}|TNCTRmtIP=%{saddr}|TNCTLocIP=%{daddr}|TNCTRmtPort=%{sport}|TNCTLocPort=%{dport}|TNCTNJENode=%{fld165}|TNCTTBytesIn=%{fld166}|TNCTTBytesOut=%{fld167}|TNCTInitDateTime=%{fld168}|TNCTTnitDateTime=%{fld169}|TNCTDur=%{fld170}|TNCTConnOpt=%{fld171}|TNCTDevType=%{fld172}|FSOper=%{fld173}|FSCmnd=%{fld174}|FSDRmtIP=%{saddr}|FSDLocIP=%{daddr}|FSDRmtPort=%{sport}|FSDLocPort=%{dport}|FSCRmtIP=%{fld179}|FSCLocIP=%{fld180}|FSCRmtPort=%{fld181}|FSCLocPort=%{fld182}|FSClntUser=%{fld183}|FSDType=%{fld184}|FSMode=%{fld185}|FSStruc=%{fld186}|FSDStype=%{fld187}|FSStrtDateTime=%{fld188}|FSEndDateTime=%{fld189}|FSDur=%{fld190}|FSBytes=%{fld191}|FSReply=%{fld192}|FSPDSMem=%{fld193}|FSAbend=%{fld194}|FSPDS2Mem=%{fld195}|FSBytesFlt=%{fld196}|FSCtrlConn=%{fld197}|FSDataConn=%{fld198}|FSSessID=%{fld199}|FSHostName=%{fld200}|FSFileName1=%{fld201}|FSFileName2=%{fld202}|FSProtMech=%{fld203}|FSCntrlProtLevel=%{fld204}|FSDataProtLevel=%{fld205}|FSLoginMethod=%{fld206}|FSProtocolLvl=%{fld207}|FSCipherSpec=%{fld208}|FSProtBuffSize=%{fld209}|FSCipher=%{fld210}|FFRmtIP=%{saddr}|FFLocIP=%{daddr}|FFRmtPort=%{sport}|FFLocPort=%{dport}|FFClntUser=%{fld215}|FFRsn=%{fld216}|FFCtrlConnID=%{fld217}|FFSessID=%{fld218}|FFProtMech=%{fld219}|FFCntrlProtLevel=%{fld220}|FFDataProtLevel=%{fld221}|FFLoginMethod=%{fld222}|FFProtocolLvl=%{fld223}|FFCipherSpec=%{fld224}|FFProtBuffSize=%{fld225}|FFCipher=%{fld226}|FCFType=%{fld227}|FSFType=%{fld228}|FTPType=%{fld1}|FSType=%{fld3}" }
			id => "msgParserId9"
			add_field => {
				"[logstash][fullDateTimeString]" => "%{fld5}"
				"[logstash][messagefound]" => true
			}
		}
		if [logstash][fullDateTimeString] {
			date { match => [ "[logstash][fullDateTimeString]", "d-M-yyyy H:m:s" ] }
		}
	}


################## END OF MESSAGES ##################

# End of the filter block
}

# Enrich events using VALUEMAP
filter {
	translate {
		field => "[fld2]"
		destination => "[ec_subject]"
		dictionary => {
			"1" => "NetworkComm"
			"2" => "NetworkComm"
			"3" => "NetworkComm"
			"20" => "NetworkComm"
			"21" => "NetworkComm"
			"22" => "NetworkComm"
			"23" => "NetworkComm"
			"70" => "NetworkComm"
			"72" => "NetworkComm"
		}
		fallback => ""
		override => true
	}
}
filter {
	translate {
		field => "[fld2]"
		destination => "[ec_activity]"
		dictionary => {
			"1" => "Start"
			"2" => "Stop"
			"3" => "Receive"
			"20" => "Start"
			"21" => "Stop"
			"22" => "Start"
			"23" => "Stop"
			"70" => "Receive"
			"72" => "Logon"
		}
		fallback => ""
		override => true
	}
}
filter {
	translate {
		field => "[fld2]"
		destination => "[ec_theme]"
		dictionary => {
			"1" => "Configuration"
			"2" => "Configuration"
			"3" => "Configuration"
			"20" => "Configuration"
			"21" => "Configuration"
			"22" => "Configuration"
			"23" => "Configuration"
			"70" => "Configuration"
			"72" => "Authentication"
		}
		fallback => ""
		override => true
	}
}
filter {
	translate {
		field => "[fld2]"
		destination => "[ec_outcome]"
		dictionary => {
			"1" => "Success"
			"2" => "Success"
			"3" => "Success"
			"20" => "Success"
			"21" => "Success"
			"22" => "Success"
			"23" => "Success"
			"70" => "Success"
			"72" => "Failure"
		}
		fallback => ""
		override => true
	}
}


output {
#	if [logstash][headerfound] and [logstash][messagefound] {
#		elasticsearch {
#			hosts => ["https://elasticxxxxxx"]
#			index => "%{[observer][product]}-%{+YYYY.MM.dd}"
#			user => "logstash"
#			password => "abc"	# Better use keystore, cf https://www.elastic.co/guide/en/logstash/master/keystore.html
#			manage_template => true
#			template => "es-mapping-ibmmainframeipsecmsg.json"
#			template_name => "ibmmainframeipsec_template"
#			template_overwrite => true
#		}
#	} else {
#		# using a file output for logs that were not parsed correctly
#		# should you chose to send it to elasticsearch, please read https://discuss.elastic.co/t/latency-with-2-elasticsearch-systems/170074/2
#		file { path => "failed_logs-%{[observer][product]}-%{+YYYY-MM-dd}" }
#	}
	stdout {
		codec => rubydebug
	}
}
